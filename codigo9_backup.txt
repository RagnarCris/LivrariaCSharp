using System;
using LivrariaCSharp.controller;
using LivrariaCSharp.model;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace LivrariaCSharp
{
    public partial class FormAcervo : Form
    {
        public FormAcervo()
        {
            InitializeComponent();
            this.Text = "Controle de Acervos";
            txtId.Enabled = false;
            estadoControles(true);
            cbxEditora.DataSource = new EditoraDAO().listar();
            cbxEditora.ValueMember = "Id";
            cbxEditora.DisplayMember = "Nome";
            cbxEditora.SelectedIndex = 0;
            cbxAtivo.Items.Add("Sim");
            cbxAtivo.Items.Add("Não");
            cbxAtivo.SelectedIndex = 0;
            configurarTabela();
            preencherTabela(new AcervoDAO().listar());
        }




        private void estadoControles(bool e)
        {
            btnNovo.Enabled = e;
            btnEditar.Enabled = e;
            btnSalvar.Enabled = !e;

            btnCancelar.Enabled = !e;
            btnPesquisar.Enabled = e;
            txtNome.Enabled = !e;
            cbxEditora.Enabled = !e;
            txtValorUnitario.Enabled = !e;
            txtQuantidade.Enabled = !e;
            cbxAtivo.Enabled = !e;
            txtPesquisar.Enabled = e;
        }


        #region EVENTOS
        private void btnNovo_Click(object sender, System.EventArgs e)
        {
            estadoControles(false);
            txtId.Text = string.Empty;
            txtNome.Text = string.Empty;
            cbxEditora.SelectedIndex = 0;
            txtValorUnitario.Text = string.Empty;
            txtQuantidade.Text = string.Empty;
            cbxAtivo.SelectedIndex = 0;
            txtNome.Focus();
        }

        private void btnEditar_Click(object sender,
        System.EventArgs e)
        {
            if (txtId.Text != string.Empty)
            {
                estadoControles(false);
            }
            else
            {
                MessageBox.Show("Selecione o acervo que deseja editar.");
            }
        }
        private void btnSalvar_Click(object sender, System.EventArgs e)
        {
            estadoControles(true);
            Acervo p = new Acervo();
            if (txtId.Text != string.Empty)
            {
                Id = int.Parse(txtId.Text);
            }
            p.Nome = txtNome.Text;
            p.Id_editora =
             ((Editora)cbxEditora.SelectedItem).Id;
            p.ValorUnitario = double.Parse(txtValorUnitario.Text);
            p.Quantidade = int.Parse(txtQuantidade.Text);
            p.Ativo = (cbxAtivo.SelectedIndex == 0);
            int res = -1;
            if (p.Id == 0)
            {
                res = new AcervoDAO().inserir(p);
                txtId.Text = res.ToString();

            }
            else
            {
                res = new AcervoDAO().atualizar(p);

            }

            if (res > 0)
            {
                MessageBox.Show("Operação realizada com sucesso!.");
                preencherTabela(new AcervoDAO().listar());
            }
            else
            {
                MessageBox.Show("Não foi possível realizar a operação.");
            }
        }

        private void btnCancelar_Click(object sender,
        System.EventArgs e)
        {
            estadoControles(true);
        }

        private void grid_CellClick(object sender, DataGridViewCellEventArgs e)
        {
            int linha = e.RowIndex;
            if (linha >= 0 && btnNovo.Enabled)
            {
                txtId.Text =
                grid.Rows[linha].Cells[0].Value.ToString();
                txtNome.Text =
                grid.Rows[linha].Cells[1].Value.ToString();
                cbxEditora.SelectedItem = grid.Rows[linha].Cells[2].Value;
                txtValorUnitario.Text = grid.Rows[linha].Cells[3].Value.ToString();
                txtQuantidade.Text = grid.Rows[linha].Cells[4].Value.ToString();
                cbxAtivo.SelectedItem = grid.Rows[linha].Cells[5].Value.ToString();
            }
        }

        private void btnPesquisar_Click(object sender, System.EventArgs e)
        {
            if
            (string.IsNullOrEmpty(txtPesquisar.Text))
            {
                preencherTabela(new AcervoDAO().listar());
            }
            else
            {
                preencherTabela(new AcervoDAO().pesquisarPorNome(txtPesquisar.Text));
            }
        }

        #endregion

        #region MÉTODOS AUXILIARES
        private void configurarTabela()
        {
            grid.Columns.Add("id", "Id");
            grid.Columns.Add("nome", "Nome");
            grid.Columns.Add("Editora", "Editora");
            grid.Columns.Add("valorunitario", "Vl.Unit");
            grid.Columns.Add("quantidade", "Qtde.");
            grid.Columns.Add("ativo", "Ativo");
            grid.Columns[0].Width = 30;
            grid.Columns[1].Width = 250;
            grid.Columns[2].Width = 100;
            grid.Columns[3].Width = 50;
            grid.Columns[4].Width = 50;
            grid.Columns[5].Width = 50;
            grid.SelectionMode = DataGridViewSelectionMode.FullRowSelect;
            grid.AllowUserToAddRows = false;
            grid.AllowUserToDeleteRows = false;
            grid.AllowUserToOrderColumns = false;
            grid.AllowUserToResizeColumns = false;
            grid.AllowUserToResizeRows = false;
            grid.ReadOnly = true;
        }
        private void preencherTabela(List<Acervo> lista)
        {
            if (lista.Count > 0)
            {
                grid.Rows.Clear();
                foreach (Acervo p in lista)
                {
                    cbxEditora.SelectedValue = p.Id_editora;
                    grid.Rows.Add(new object[] { p.Id, p.Nome, cbxEditora.SelectedItem, p.ValorUnitario, p.Quantidade, p.Ativo ? "Sim" : "Não" });
                }
                cbxEditora.SelectedIndex = 0;
            }
        }
        #endregion
    }
}
